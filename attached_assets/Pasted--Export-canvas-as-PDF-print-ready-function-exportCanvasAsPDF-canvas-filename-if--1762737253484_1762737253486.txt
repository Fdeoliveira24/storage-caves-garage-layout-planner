/**
 * Export canvas as PDF (print-ready)
 */
function exportCanvasAsPDF(canvas, filename) {
  if (!filename) {
    filename = `garage_layout_${new Date().toISOString().slice(0, 10)}.pdf`;
  }
  
  // Deselect all objects for clean export
  canvas.discardActiveObject();
  canvas.renderAll();
  
  // Get canvas dimensions in pixels
  const canvasWidth = canvas.width;
  const canvasHeight = canvas.height;
  
  // Standard paper sizes in mm
  const paperSizes = {
    'letter': { width: 215.9, height: 279.4, name: 'Letter (8.5" x 11")' },
    'legal': { width: 215.9, height: 355.6, name: 'Legal (8.5" x 14")' },
    'tabloid': { width: 279.4, height: 431.8, name: 'Tabloid (11" x 17")' },
    'a4': { width: 210, height: 297, name: 'A4' },
    'a3': { width: 297, height: 420, name: 'A3' }
  };
  
  // Determine best paper size based on canvas aspect ratio
  const canvasAspectRatio = canvasWidth / canvasHeight;
  
  // Choose paper size - prefer Letter for smaller layouts, Tabloid for larger
  let paperSize;
  if (canvasAspectRatio > 0.8) {
    // More square or landscape - use landscape orientation
    paperSize = canvasWidth > 700 ? paperSizes.tabloid : paperSizes.letter;
  } else {
    // Portrait - use portrait orientation
    paperSize = canvasHeight > 1000 ? paperSizes.tabloid : paperSizes.letter;
  }
  
  // Determine orientation
  const orientation = canvasAspectRatio > 1 ? 'landscape' : 'portrait';
  const pageWidth = orientation === 'landscape' ? Math.max(paperSize.width, paperSize.height) : Math.min(paperSize.width, paperSize.height);
  const pageHeight = orientation === 'landscape' ? Math.min(paperSize.width, paperSize.height) : Math.max(paperSize.width, paperSize.height);
  
  // Create PDF with standard paper size
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: orientation,
    unit: 'mm',
    format: orientation === 'landscape' ? [pageHeight, pageWidth] : [pageWidth, pageHeight],
    compress: true
  });
  
  // Calculate margins (0.5 inch = 12.7mm)
  const margin = 12.7;
  const printWidth = pageWidth - (margin * 2);
  const printHeight = pageHeight - (margin * 2);
  
  // Calculate scale to fit canvas on page while maintaining aspect ratio
  const scaleX = printWidth / canvasWidth;
  const scaleY = printHeight / canvasHeight;
  const scale = Math.min(scaleX, scaleY);
  
  const finalWidth = canvasWidth * scale;
  const finalHeight = canvasHeight * scale;
  
  // Center on page
  const x = margin + (printWidth - finalWidth) / 2;
  const y = margin + (printHeight - finalHeight) / 2;
  
  // Export canvas to high-res image
  const imgData = canvas.toDataURL({
    format: 'png',
    quality: 1,
    multiplier: 3 // 3x resolution for crisp printing at 300 DPI
  });
  
  // Add image to PDF
  pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight, undefined, 'FAST');
  
  // Add metadata
  pdf.setProperties({
    title: 'Garage Layout Plan',
    subject: 'Garage Layout Design',
    author: 'Garage Layout Planner',
    keywords: 'garage, layout, plan, design',
    creator: 'Garage Layout Planner'
  });
  
  // Save the PDF
  pdf.save(filename);
}